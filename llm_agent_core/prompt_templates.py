# ğŸ“ llm_agent_core/prompt_templates.py

from typing import Dict, Any, List

# --- I. æ ¸å¿ƒç³»ç»Ÿ Prompt ---

CORE_SYSTEM_PROMPT = """
ä½ æ˜¯ä¸€ä¸ªéƒ¨ç½²åœ¨åœ°é¢ç«™ï¼ˆGCSï¼‰ä¸Šçš„é«˜çº§æ— äººæœºï¼ˆUAVï¼‰è§„åˆ’ Agentï¼Œä½ çš„ç›®æ ‡æ˜¯é«˜æ•ˆã€å®‰å…¨åœ°å®Œæˆç”¨æˆ·çš„æœç´¢ä»»åŠ¡ã€‚ä½ è´Ÿè´£å®è§‚æˆ˜ç•¥è§„åˆ’ã€ä»»åŠ¡åˆ†è§£ã€GPS èˆªçº¿è®¡ç®—å’Œè®°å¿†ç®¡ç†ã€‚æ— äººæœºè‡ªèº«é…å¤‡äº† VLAï¼ˆè§†è§‰-è¯­è¨€-åŠ¨ä½œï¼‰è¾¹ç¼˜æ¨¡å‹ï¼Œç”¨äºæ‰§è¡Œä½ ä¸‹è¾¾çš„å±€éƒ¨ã€ç²¾ç»†çš„è§†è§‰æŒ‡ä»¤ã€‚

è¯·å§‹ç»ˆä½¿ç”¨ Thought/Action/Observation çš„è¿­ä»£å¾ªç¯ã€‚

---

# [ä¸€ã€LLM æœç´¢è§„åˆ’æ ¸å¿ƒæµç¨‹ (å®è§‚/å¾®è§‚åˆ‡æ¢)]

ä½ çš„ä»»åŠ¡å°†åˆ†ä¸ºå®è§‚éƒ¨ç½²å’Œå¾®è§‚æœç´¢ä¸¤ä¸ªé˜¶æ®µã€‚

## A. å®è§‚éƒ¨ç½²é˜¶æ®µ (ä½¿ç”¨ GPS)
* **ç›®æ ‡ï¼š** ä½¿ç”¨ fly_to_gps å¿«é€Ÿåˆ°è¾¾ç›®æ ‡åŒºåŸŸçš„ä¸Šç©ºï¼ˆä¾‹å¦‚ 100ç±³é«˜åº¦ï¼‰ã€‚
* **è§¦å‘ï¼š** ä»»åŠ¡å¼€å§‹æ—¶ï¼Œæˆ–å½“å‰æœç´¢åŒºåŸŸå®Œæˆï¼Œéœ€è¦ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªè¿œè·ç¦»æœç´¢åŒºåŸŸæ—¶ã€‚

## B. å¾®è§‚æœç´¢é˜¶æ®µ (ä½¿ç”¨ VLA/RAG)
* **è§¦å‘ï¼š** å®è§‚éƒ¨ç½²æˆåŠŸåï¼Œä½ éœ€è¦å°†é«˜åº¦é™è‡³æœç´¢é«˜åº¦ï¼ˆä¾‹å¦‚ 20-30ç±³ï¼‰ï¼Œå¹¶å¼€å§‹ç²¾ç»†æœç´¢ã€‚
* **è§„åˆ’è¿­ä»£é€»è¾‘ï¼ˆä½ å¿…é¡»éµå¾ªæ­¤æµç¨‹ï¼‰ï¼š**

### 1. çŠ¶æ€ä¸ç›®æ ‡ç¡®è®¤ (Status & Goal Check)
* è°ƒç”¨ `get_current_pose` ç¡®è®¤å½“å‰ç²¾ç¡®ä½ç½®å’Œé«˜åº¦ã€‚
* å›é¡¾ç”¨æˆ·çš„åˆå§‹ç›®æ ‡ã€‚

### 2. å†å²ä¿¡æ¯æ£€ç´¢ (Memory Retrieval - RAG)
* å¿…é¡»è°ƒç”¨ `retrieve_historical_clues`ï¼ŒæŸ¥è¯¢ä»¥ä¸‹ä¿¡æ¯ï¼š
    * **æœªæ¢ç´¢åŒºåŸŸï¼š** 'åœ¨å½“å‰ä½ç½®é™„è¿‘ï¼Œå“ªäº›åŒºåŸŸæˆ–æ‰‡åŒºå°šæœªè¢«æ¢ç´¢ï¼Ÿ'
    * **å·²æœ‰çº¿ç´¢ï¼š** 'å½“å‰ä½ç½®é™„è¿‘æ˜¯å¦æœ‰ä»»ä½•å·²è®°å½•çš„çº¿ç´¢ã€å¯ç–‘ç›®æ ‡æˆ–é‡è¦åœ°æ ‡ï¼Ÿ'

### 3. æˆ˜æœ¯å†³ç­–ä¸ VLA æŒ‡ä»¤ç”Ÿæˆ (Tactical Decision)
* **åŸºäºæ£€ç´¢ç»“æœåˆ¶å®šæˆ˜æœ¯ï¼š**
    * **ä¼˜å…ˆ** é è¿‘å¹¶æ£€æŸ¥ `retrieve_historical_clues` å¬å›çš„ä»»ä½•**å¯ç–‘çº¿ç´¢**ã€‚
    * **å…¶æ¬¡** è§„åˆ’è¦†ç›–æœ€å¤§çš„ **æœªæ¢ç´¢åŒºåŸŸ**ï¼Œä¾‹å¦‚ï¼šä»å½“å‰ä½ç½®å¼€å§‹ä¸€ä¸ªèºæ—‹æœç´¢ã€ä¸€ä¸ª S å½¢æ …æ ¼æœç´¢ï¼Œæˆ–ç¯ç»•ä¸€ä¸ªæœªæ¢ç´¢çš„è¯­ä¹‰å®ä½“ã€‚
* **ç”Ÿæˆ VLA æŒ‡ä»¤ï¼š**
    * å¿…é¡»ä½¿ç”¨ `execute_vln_instruction`ã€‚æŒ‡ä»¤å¿…é¡»æ˜¯**å…·èº«çš„ (Embodied)**ã€**çŸ­ç¨‹çš„**ï¼Œä¸”èšç„¦äºå½“å‰**å¯è§çš„è¯­ä¹‰å®ä½“**æˆ–**æ˜ç¡®çš„ç©ºé—´å…³ç³»**ã€‚

### 4. è¡ŒåŠ¨ä¸è®°å¿†æ›´æ–° (Action & Memory Update)
* **VLA åé¦ˆå¤„ç†ï¼š** æ”¶åˆ° `execute_vln_instruction` çš„ Observation åï¼Œå¦‚æœæŠ¥å‘Šå‘ç°äº†**ä»»ä½•æ–°çº¿ç´¢æˆ–ç›®æ ‡**ï¼Œå¿…é¡»**ç«‹å³**è°ƒç”¨ `update_search_map` å°†å…¶ç²¾ç¡®ä½ç½®å’Œæè¿°è®°å½•ã€‚
* **åŒºåŸŸæ ‡è®°ï¼š** å¦‚æœ VLA å®Œæˆä¸€ä¸ªåŒºåŸŸçš„æœç´¢ï¼ˆä¾‹å¦‚èºæ—‹æœç´¢ç»“æŸï¼‰ï¼Œä½ ä¹Ÿåº”è¯¥è°ƒç”¨ `update_search_map` è®°å½• 'å½“å‰åŒºåŸŸå·²æ¢ç´¢å®Œæˆ'ï¼Œé¿å…é‡å¤ã€‚

---

# [äºŒã€å·¥å…·å®šä¹‰ä¸ä½¿ç”¨çº¦æŸ]

### 1. fly_to_gps(latitude, longitude, altitude, speed)
* **æè¿°:** æ— äººæœºå¿«é€Ÿé£å‘æŒ‡å®šçš„ GPS åæ ‡å’Œé«˜åº¦ã€‚ä¸»è¦ç”¨äºå®è§‚éƒ¨ç½²ã€‚
* **çº¦æŸ:** altitude å¿…é¡»è®¾ç½®ä¸€ä¸ªå…·ä½“çš„æ•°å­—ï¼ˆä¾‹å¦‚ 100.0ï¼‰ã€‚

### 2. execute_vln_instruction(language_instruction)
* **æè¿°:** å°†æ§åˆ¶æƒäº¤ç»™ VLA æ¨¡å‹ï¼Œæ‰§è¡Œå¤æ‚çš„å±€éƒ¨è§†è§‰-è¯­è¨€å¯¼èˆªä»»åŠ¡ï¼ˆç²¾ç»†é¿éšœã€è¿‘è·ç¦»æœç´¢ã€ç›®æ ‡æ¥è¿‘ï¼‰ã€‚
* **çº¦æŸ:** language_instruction å¿…é¡»ä½¿ç”¨å…·ä½“çš„è§†è§‰è¯­ä¹‰ï¼Œä¾‹å¦‚ï¼š"æ²¿ç€å‰æ–¹çš„ç™½è‰²å¢™å£å‘å·¦ç§»åŠ¨ 10 ç±³ï¼Œå¯»æ‰¾ä»»ä½•æ ‡è®°ã€‚"

### 3. retrieve_historical_clues(query)
* **æè¿°:** ä»é•¿æœŸè®°å¿†ä¸­æ£€ç´¢ä¸ query æœ€ç›¸å…³çš„å†å²çº¿ç´¢ã€å·²æ¢ç´¢åŒºåŸŸæˆ–é™æ€è¯­ä¹‰åœ°å›¾ä¿¡æ¯ã€‚
* **ç”¨é€”:** å¿…é¡»åœ¨è§„åˆ’æœç´¢è½¨è¿¹å‰è°ƒç”¨ã€‚

### 4. update_search_map(x, y, z, description)
* **æè¿°:** è®°å½•æ–°çš„çº¿ç´¢ã€å·²å‘ç°ç›®æ ‡çš„ä½ç½®ï¼Œæˆ–æ ‡è®°ä¸€å—åŒºåŸŸçš„æœç´¢çŠ¶æ€ã€‚
* **çº¦æŸ:** x, y, z å¿…é¡»æ˜¯ç²¾ç¡®çš„ NED åæ ‡ã€‚

### 5. get_current_pose()
* **æè¿°:** è·å–æ— äººæœºå½“å‰çš„ GPS å’Œ NED åæ ‡ã€‚

---
"""

# --- II. å†…éƒ¨å·¥å…·å®šä¹‰ï¼ˆç®€åŒ–æ ¼å¼ï¼‰ ---

# è¿™æ˜¯ä¸€ä¸ªå†…éƒ¨å­—å…¸ï¼Œç”¨äºå®šä¹‰å·¥å…·çš„åç§°ã€æè¿°å’Œå‚æ•°ã€‚
# æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ Python ç±»å‹å­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯ JSON Schema ç±»å‹ã€‚
TOOL_SCHEMAS: Dict[str, Dict[str, Any]] = {
    # åŸºç¡€æ§åˆ¶å·¥å…· (æ¥è‡ª airsim_client.py)
    "takeoff": {
        "description": "æ‰§è¡Œæ— äººæœºèµ·é£æ“ä½œï¼Œç”¨äºå¼€å§‹ä»»åŠ¡ã€‚èµ·é£åˆ°å®‰å…¨é«˜åº¦ã€‚",
        "parameters": {"altitude": "float (ç›®æ ‡é«˜åº¦ï¼Œå•ä½ï¼šç±³)"}
    },
    "land": {
        "description": "å®‰å…¨é™è½å¹¶è§£é™¤é”å®šï¼Œç”¨äºç»“æŸæˆ–æš‚åœä»»åŠ¡ã€‚",
        "parameters": {}
    },
    "get_current_pose": {
        "description": "è·å–æ— äººæœºå½“å‰çš„ GPS åæ ‡ã€é«˜åº¦å’Œå§¿æ€ï¼Œç”¨äºè§„åˆ’è·¯å¾„ã€‚",
        "parameters": {}
    },

    # é«˜çº§é£è¡Œå·¥å…· (æ¥è‡ª uav_tools/flight_controls.py)
    "fly_to_gps": {
        "description": "é£å¾€æŒ‡å®šçš„å…¨çƒå®šä½ç³»ç»Ÿ (GPS) åæ ‡ç‚¹ã€‚è¿™æ˜¯é«˜çº§è§„åˆ’å±‚çš„ä¸»è¦å®è§‚è¡ŒåŠ¨å·¥å…·ã€‚",
        "parameters": {
            "latitude": "float (ç›®æ ‡çº¬åº¦)",
            "longitude": "float (ç›®æ ‡ç»åº¦)",
            "altitude_meters": "float (ç›®æ ‡é«˜åº¦ï¼Œå•ä½ï¼šç±³)"
        }
    },

   
    # æ–°å¢é¿éšœå·¥å…·
    "move_with_local_avoidance": {
        "description": "å®‰å…¨åœ°åœ¨å½“å‰èˆªå‘å‘å‰ç§»åŠ¨æŒ‡å®šè·ç¦»ï¼Œä½¿ç”¨ Lidar/æ·±åº¦ä¼ æ„Ÿå™¨è‡ªä¸»é¿å¼€å±€éƒ¨éšœç¢ç‰©ã€‚",
        "parameters": {
            "target_distance": "float (ç›®æ ‡ç§»åŠ¨è·ç¦»ï¼Œå•ä½ï¼šç±³)",
            "lidar_name": "str (AirSimä¸­Lidarä¼ æ„Ÿå™¨çš„åç§°ï¼Œä¾‹å¦‚ï¼š'Lidar1')"
        }
    },
    
    # ç¡®ä¿æ›´æ–° get_openai_tool_schemas å‡½æ•°ï¼Œå°†å…¶è½¬æ¢ä¸º JSON Schema æ ¼å¼ã€‚
    
    # è§†è§‰æ„ŸçŸ¥å·¥å…· (æ¥è‡ª uav_tools/vision_bridge.py)
    "capture_and_analyze_rgb": {
        "description": "å¯åŠ¨è§†è§‰ç³»ç»Ÿï¼Œæ•è·å›¾åƒå¹¶åˆ†ææŒ‡å®šç›®æ ‡ï¼ˆæ¨¡æ‹Ÿ YOLO æˆ– VLMï¼‰ã€‚",
        "parameters": {"target_description": "str (è¦å¯»æ‰¾çš„ç›®æ ‡çš„è‡ªç„¶è¯­è¨€æè¿°ï¼Œä¾‹å¦‚ï¼š'çº¢è‰²çš„èƒŒåŒ…')" }
    },

    # OpenFly VLA é›†æˆå·¥å…·
    "execute_vln_instruction": {
        "description": "æ¿€æ´» OpenFly VLA æ¨¡å‹ï¼Œæ‰§è¡ŒçŸ­ç¨‹ã€ååº”å¼çš„è§†è§‰-è¯­è¨€å¯¼èˆªæŒ‡ä»¤ã€‚å½“æ— äººæœºæ¥è¿‘ç›®æ ‡åŒºåŸŸæ—¶ä½¿ç”¨ã€‚",
        "parameters": {"language_instruction": "str (VLA è¦æ‰§è¡Œçš„çŸ­è¯­æŒ‡ä»¤ï¼Œå¦‚'å‘å·¦è¾¹çš„å¤§æ ‘é è¿‘')" }
    },

    # æŠ¥å‘Šå·¥å…·
    "report_finding": {
        "description": "å½“ç¡®å®šæ‰¾åˆ°ä»»åŠ¡ç›®æ ‡æ—¶ï¼Œå¿…é¡»è°ƒç”¨æ­¤å‡½æ•°ã€‚",
        "parameters": {
            "coordinates": "str (ç›®æ ‡çš„ GPS åæ ‡ï¼Œæ ¼å¼ä¸º Lat: x.xxxx, Lon: y.yyyy, Alt: z.zzm)",
            "description": "str (ç›®æ ‡çš„è¯¦ç»†æè¿°)"
        }
    }
}

# --- III. è½¬æ¢å‡½æ•° (è§£å†³å¯¼å…¥é”™è¯¯) ---

# ç±»å‹æ˜ å°„è¡¨ï¼Œç”¨äºå°† Python å­—ç¬¦ä¸²æ˜ å°„åˆ° JSON Schema ç±»å‹
TYPE_MAP = {
    "float": "number",
    "str": "string",
    "dict": "object",
    "list": "array",
    "int": "integer"
}


def get_openai_tool_schemas() -> List[Dict[str, Any]]:
    """
    å°† TOOL_SCHEMAS è½¬æ¢ä¸º OpenAI Function Calling æ‰€éœ€çš„ä¸¥æ ¼ JSON Schema æ ¼å¼ã€‚
    """
    openai_schemas = []
    
    for name, definition in TOOL_SCHEMAS.items():
        function_schema = {
            "name": name,
            "description": definition["description"],
            "parameters": {
                "type": "object",
                "properties": {},
                "required": []
            }
        }
        
        # å¤„ç†å‚æ•°
        if "parameters" in definition:
            for param_name, type_str in definition["parameters"].items():
                # ç®€å•è§£æç±»å‹å’Œæè¿°
                parts = type_str.split(' ', 1)
                param_type = parts[0].lower()
                param_desc = parts[1] if len(parts) > 1 else f"å‚æ•° {param_name}"

                # è½¬æ¢ä¸º JSON Schema ç±»å‹
                json_type = TYPE_MAP.get(param_type, "string") # é»˜è®¤ä¸º string
                
                function_schema["parameters"]["properties"][param_name] = {
                    "type": json_type,
                    "description": param_desc
                }
                # å‡è®¾æ‰€æœ‰å®šä¹‰çš„å‚æ•°éƒ½æ˜¯å¿…å¡«çš„
                function_schema["parameters"]["required"].append(param_name)

        openai_schemas.append({
            "type": "function",
            "function": function_schema
        })
        
    return openai_schemas